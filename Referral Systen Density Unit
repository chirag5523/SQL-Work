/*
TITLE: T875 - Referral System Density Audit
DESCRIPTION: 
    Analyzes patient referrals across multiple systems (e.g., RiO and SystmOne).
    Calculates waiting times from both the overall referral and team transfer dates.
    Includes grouping for days since last seen and validation for Dialog Assessments.
*/

SELECT 
    DEMO.*,
    MAX(SYSTEM_CHECK) OVER (PARTITION BY DEMO.NHS_NO) AS COUNT_GROUP,
    CASE	
        WHEN MAX(SYSTEM_CHECK) OVER (PARTITION BY DEMO.NHS_NO) = 2 THEN 'OPEN ON RIO & SYSTMONE' 
        ELSE 'OPEN ONLY ON ONE SYSTEM'
    END AS ONE_OR_TWO_SYSTEM
FROM (
    SELECT DISTINCT 
        T.*,
        CASE 
            WHEN T.DAYS_SINCE_LAST_SEEN < 90   THEN 'LESS THAN 90 DAYS SINCE LAST APPOINTMENT'
            WHEN T.DAYS_SINCE_LAST_SEEN BETWEEN 90 AND 179  THEN '90 TO 179 DAYS SINCE LAST APPOINTMENT'
            WHEN T.DAYS_SINCE_LAST_SEEN BETWEEN 180 AND 364 THEN '180 TO 364 DAYS SINCE LAST APPOINTMENT'
            WHEN T.DAYS_SINCE_LAST_SEEN BETWEEN 365 AND 728 THEN '365 TO 728 DAYS SINCE LAST APPOINTMENT'
            WHEN T.DAYS_SINCE_LAST_SEEN > 728  THEN '104 WEEKS SINCE LAST APPOINTMENT'
        END AS DAYS_SINCE_LAST_SEEN_GROUP,
        DENSE_RANK() OVER (
            PARTITION BY T.NHS_NO, CASE WHEN T.SS_CODE_OPEN = 'CLOSED' THEN 1 END
            ORDER BY T.SS_CODE_OPEN
        ) AS SYSTEM_CHECK
    FROM (
        SELECT DISTINCT
            CASE WHEN A.SS_CODE = 'MINT' THEN 'SYSTEM1' ELSE A.SS_CODE END AS SS_CODE,
            A.PATIENT_KEY,
            A.NHS_NO,
            A.CLIENTID,
            A.PCN_NAME,
            A.GENDER_DESC,
            A.PRACTICE_NAME,
            A.SUB_TEAM_NAME,
            A.TEAM_NAME,
            A.REFERRAL_UNIQUE_ID,
            A.CASELOAD_START_DATE_TIME AS REFERRAL_TRANSFER_START_DATE,
            A.CASELOAD_END_DATE_TIME   AS REFERRAL_TRANSFER_END_DATE, 
            D1.FULL_DATE AS OVERALL_REFERRAL_START_DATE,
            DATEDIFF(DD, D1.FULL_DATE, GETDATE()) AS DAYS_ON_REFERRAL,
            F.FULL_DATE AS LATEST_APT_DATE,

            -- Clock start logic for wait times
            CASE 
                WHEN DATEDIFF(DD, D1.FULL_DATE, GETDATE()) < DATEDIFF(DD, ISNULL(F.FULL_DATE, D1.FULL_DATE), GETDATE())
                THEN DATEDIFF(DD, D1.FULL_DATE, GETDATE()) 
                ELSE DATEDIFF(DD, ISNULL(F.FULL_DATE, D1.FULL_DATE), GETDATE()) 
            END AS DAYS_SINCE_LAST_SEEN,

            F1.FULL_DATE AS FIRST_APT_SINCE_TRANSFER,
            CASE WHEN F1.FULL_DATE IS NULL THEN 'Y' ELSE 'N' END AS WAITING_FOR_FIRST_APT_SINCE_TRANSFER,
            DATEDIFF(DD, A.CASELOAD_START_DATE_TIME, F1.FULL_DATE) AS TRANSFER_TO_FIRST_APT_DAYS,

            F2.FULL_DATE AS FIRST_APT_SINCE_OVERALL_REFERRAL,
            CASE WHEN F2.FULL_DATE IS NULL THEN 'Y' ELSE 'N' END AS WAITING_FOR_FIRST_APT_SINCE_OVERALL_REFERRAL,
            DATEDIFF(DD, D1.FULL_DATE, F2.FULL_DATE) AS OVERALL_REFERRAL_TO_FIRST_APT_DAYS,

            F12.FULL_DATE AS SECOND_APT_SINCE_TRANSFER,
            CASE WHEN F12.FULL_DATE IS NULL THEN 'Y' ELSE 'N' END AS WAITING_FOR_SECOND_APT_SINCE_TRANSFER,
            DATEDIFF(DD, A.CASELOAD_START_DATE_TIME, F12.FULL_DATE) AS TRANSFER_TO_SECOND_APT_DAYS,

            F22.FULL_DATE AS SECOND_APT_SINCE_OVERALL_REFERRAL,
            CASE WHEN F22.FULL_DATE IS NULL THEN 'Y' ELSE 'N' END AS WAITING_FOR_SECOND_APT_SINCE_OVERALL_REFERRAL,
            DATEDIFF(DD, D1.FULL_DATE, F22.FULL_DATE) AS OVERALL_REFERRAL_TO_SECOND_APT_DAYS,

            DATEDIFF(DD, F1.FULL_DATE, F12.FULL_DATE) AS DAYS_FIRST_TO_SECOND_APT_SINCE_TRANSFER,
            DATEDIFF(DD, F2.FULL_DATE, F22.FULL_DATE) AS DAYS_FIRST_TO_SECOND_APT_OVERALL_REFERRAL,

            D.REFERRAL_SOURCE_DESC,
            D.REFERRAL_REASON_DESC,
            D.REJECTION_REASON_DESC,
            D.PRIORITY_DESC,

            G.ASSESSMENT_ID AS DIALOG_ASSESSMENT_ID,
            G1.FULL_DATE AS DIALOG_ASSESSMENT_DATE,
            DATEDIFF(DD, G1.FULL_DATE, GETDATE()) AS DAYS_SINCE_LAST_DIALOG_ASSESSMENT,
            CASE 
                WHEN DATEDIFF(DD, G1.FULL_DATE, GETDATE()) > 365 THEN 'MORE_THAN_365_DAYS'
                WHEN DATEDIFF(DD, G1.FULL_DATE, GETDATE()) < 365 THEN 'LESS_THAN_365_DAYS'
            END AS DAYS_GROUP_SINCE_LAST_DIALOG_ASSESSMENT,

            CASE	
                WHEN A.CASELOAD_END_DATE_TIME IS NOT NULL THEN 'CLOSED' 
                WHEN A.CASELOAD_END_DATE_TIME IS NULL     THEN A.SS_CODE
                ELSE 'CHECK'
            END AS SS_CODE_OPEN

        FROM (
            -- Caseload History
            SELECT  
                CL.SS_CODE, CL.PATIENT_KEY, PT.CLIENTID, PT.NHS_NO, PT.PCN_NAME, PT.PRACTICE_NAME,
                PT.GENDER_DESC, CL.REFERRAL_UNIQUE_ID, CL.START_DATE_KEY, CL.START_TIME, CL.END_DATE_KEY,
                CONVERT(DATETIME, CONVERT(CHAR(8), CL.START_DATE_KEY, 112) + ' ' + CONVERT(CHAR(8), CL.START_TIME, 108)) AS CASELOAD_START_DATE_TIME,
                CONVERT(DATETIME, CONVERT(CHAR(8), CL.END_DATE_KEY, 112) + ' ' + CONVERT(CHAR(8), CL.END_TIME, 108))     AS CASELOAD_END_DATE_TIME,
                CL.CASELOAD_NAME AS SUB_TEAM_NAME, CL.CASELOAD_TEAM AS TEAM_NAME,
                CL.START_DATE_KEY AS ALLOCATION_START_DATE_KEY
            FROM FACT_CASELOAD_HISTORY CL 
            INNER JOIN DIM_PATIENT PT ON CL.PATIENT_KEY = PT.PATIENT_KEY AND PT.RECORD_STATUS = 'A'
            WHERE CL.CASELOAD_TEAM LIKE '%MINT%'

            UNION ALL

            -- Referral Service
            SELECT  
                SR.SS_CODE, SR.PATIENT_KEY, PT.CLIENTID, PT.NHS_NO, PT.PCN_NAME, PT.PRACTICE_NAME,
                PT.GENDER_DESC, SR.REFERRAL_UNIQUE_ID, SR.ALLOCATION_START_DATE_KEY, SR.ALLOCATION_START_TIME, SR.ALLOCATION_END_DATE_KEY,
                CONVERT(DATETIME, CONVERT(CHAR(8), SR.ALLOCATION_START_DATE_KEY, 112) + ' ' + CONVERT(CHAR(8), SR.ALLOCATION_START_TIME, 108)) AS CASELOAD_START_DATE_TIME,
                CONVERT(DATETIME, CONVERT(CHAR(8), SR.ALLOCATION_END_DATE_KEY, 112) + ' ' + CONVERT(CHAR(8), SR.ALLOCATION_END_TIME, 108))     AS CASELOAD_END_DATE_TIME,
                B.SERVICE_SSDESC AS SUB_TEAM_NAME, B.SERVICE_SSDESC AS TEAM_NAME,
                SR.ALLOCATION_START_DATE_KEY
            FROM FACT_REFERRAL_SERVICE SR
            LEFT JOIN DIM_SERVICE B ON SR.SERVICE_KEY = B.SERVICE_KEY AND B.RECORD_STATUS = 'A'
            INNER JOIN DIM_PATIENT PT ON SR.PATIENT_KEY = PT.PATIENT_KEY AND PT.RECORD_STATUS = 'A'
            WHERE B.SERVICE_SSDESC LIKE '%MINT%'
        ) A
        LEFT JOIN FACT_REFERRAL D ON A.PATIENT_KEY = D.PATIENT_KEY AND A.REFERRAL_UNIQUE_ID = D.REFERRAL_UNIQUE_ID
        INNER JOIN DIM_DATE D1 ON D.REFERRAL_DATE_KEY = D1.DATE_KEY

        -- LATEST APPOINTMENT OVERALL
        OUTER APPLY (
            SELECT TOP 1 DT.FULL_DATE, APP.APPOINTMENT_DATE_KEY 
            FROM FACT_APPOINTMENT APP
            INNER JOIN DIM_PATIENT PT ON APP.PATIENT_KEY = PT.PATIENT_KEY AND PT.RECORD_STATUS = 'A'
            INNER JOIN DIM_DATE DT ON APP.APPOINTMENT_DATE_KEY = DT.DATE_KEY
            WHERE APP.CAL_OUTCOME_DESC IN ('FTF', 'TC', 'TM')
              AND PT.NHS_NO = A.NHS_NO
              AND DT.FULL_DATE < GETDATE()
            ORDER BY APP.APPOINTMENT_DATE_KEY DESC
        ) F

        -- FIRST APPOINTMENT AFTER TRANSFER
        OUTER APPLY (
            SELECT TOP 1 DT.FULL_DATE, APP.APPOINTMENT_DATE_KEY 
            FROM FACT_APPOINTMENT APP
            INNER JOIN DIM_PATIENT PT ON APP.PATIENT_KEY = PT.PATIENT_KEY AND PT.RECORD_STATUS = 'A'
            INNER JOIN DIM_DATE DT ON APP.APPOINTMENT_DATE_KEY = DT.DATE_KEY
            WHERE APP.CAL_OUTCOME_DESC IN ('FTF', 'TC', 'TM')
              AND PT.NHS_NO = A.NHS_NO
              AND APP.APPOINTMENT_DATE_KEY >= A.ALLOCATION_START_DATE_KEY
              AND DT.FULL_DATE < GETDATE()
            ORDER BY APP.APPOINTMENT_DATE_KEY ASC
        ) F1

        -- FIRST APPOINTMENT AFTER OVERALL REFERRAL
        OUTER APPLY (
            SELECT TOP 1 DT.FULL_DATE, APP.APPOINTMENT_DATE_KEY 
            FROM FACT_APPOINTMENT APP
            INNER JOIN DIM_PATIENT PT ON APP.PATIENT_KEY = PT.PATIENT_KEY AND PT.RECORD_STATUS = 'A'
            INNER JOIN DIM_DATE DT ON APP.APPOINTMENT_DATE_KEY = DT.DATE_KEY
            WHERE APP.CAL_OUTCOME_DESC IN ('FTF', 'TC', 'TM')
              AND PT.NHS_NO = A.NHS_NO
              AND APP.APPOINTMENT_DATE_KEY >= D.REFERRAL_DATE_KEY
              AND DT.FULL_DATE < GETDATE()
            ORDER BY APP.APPOINTMENT_DATE_KEY ASC
        ) F2

        -- SECOND APPOINTMENT AFTER TRANSFER
        OUTER APPLY (
            SELECT TOP 1 DT.FULL_DATE, APP.APPOINTMENT_DATE_KEY 
            FROM FACT_APPOINTMENT APP
            INNER JOIN DIM_PATIENT PT ON APP.PATIENT_KEY = PT.PATIENT_KEY AND PT.RECORD_STATUS = 'A'
            INNER JOIN DIM_DATE DT ON APP.APPOINTMENT_DATE_KEY = DT.DATE_KEY
            WHERE APP.CAL_OUTCOME_DESC IN ('FTF', 'TC', 'TM')
              AND PT.NHS_NO = A.NHS_NO
              AND APP.APPOINTMENT_DATE_KEY >= A.ALLOCATION_START_DATE_KEY
              AND APP.APPOINTMENT_DATE_KEY > F1.APPOINTMENT_DATE_KEY
              AND DT.FULL_DATE < GETDATE()
            ORDER BY APP.APPOINTMENT_DATE_KEY ASC
        ) F12

        -- SECOND APPOINTMENT AFTER OVERALL REFERRAL
        OUTER APPLY (
            SELECT TOP 1 DT.FULL_DATE, APP.APPOINTMENT_DATE_KEY 
            FROM FACT_APPOINTMENT APP
            INNER JOIN DIM_PATIENT PT ON APP.PATIENT_KEY = PT.PATIENT_KEY AND PT.RECORD_STATUS = 'A'
            INNER JOIN DIM_DATE DT ON APP.APPOINTMENT_DATE_KEY = DT.DATE_KEY
            WHERE APP.CAL_OUTCOME_DESC IN ('FTF', 'TC', 'TM')
              AND PT.NHS_NO = A.NHS_NO
              AND APP.APPOINTMENT_DATE_KEY >= D.REFERRAL_DATE_KEY
              AND APP.APPOINTMENT_DATE_KEY > F2.APPOINTMENT_DATE_KEY
              AND DT.FULL_DATE < GETDATE()
            ORDER BY APP.APPOINTMENT_DATE_KEY ASC
        ) F22

        -- LATEST DIALOG ASSESSMENT
        OUTER APPLY (
            SELECT TOP 1 Y.ASSESSMENT_ID, Y.ASSESSMENT_DATE_KEY, Y.ASSESSMENT_DATE
            FROM (
                SELECT X.ASSESSMENT_ID, X.ASSESSMENT_DATE_KEY,
                       CONVERT(DATETIME, CONVERT(CHAR(8), X.ASSESSMENT_DATE_KEY, 112) + ' ' + CONVERT(CHAR(8), X.ASSESSMENT_TIME, 108)) AS ASSESSMENT_DATE,
                       ROW_NUMBER() OVER (PARTITION BY X.PATIENT_KEY, X.ASSESSMENT_NAME ORDER BY X.ASSESSMENT_DATE_KEY DESC) AS RKD
                FROM FACT_ASSESSMENT_DETAIL X
                INNER JOIN DIM_PATIENT PT ON X.PATIENT_KEY = PT.PATIENT_KEY AND PT.RECORD_STATUS = 'A'
                WHERE X.TABLE_NAME = 'USERASSESSDIALOGOUTCOME'
                  AND PT.NHS_NO = A.NHS_NO
            ) Y
            WHERE Y.RKD = 1
        ) G
        LEFT JOIN DIM_DATE G1 ON G.ASSESSMENT_DATE_KEY = G1.DATE_KEY

        WHERE (A.CASELOAD_START_DATE_TIME >= '2021-07-01' OR A.CASELOAD_END_DATE_TIME >= '2021-07-01') 
           OR (A.CASELOAD_END_DATE_TIME IS NULL)
    ) T
) DEMO
WHERE DEMO.NHS_NO IN ('4001957655');
