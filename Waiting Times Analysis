/*
TITLE: Waiting Times Analysis
DESCRIPTION: 
    Calculates access wait times for benchmarking. 
    Includes active patients as of @END_DATE and those discharged during the year.
    Clock start resets to DNA date if the patient DNAs before the first FTF.
*/

DECLARE @START_DATE DATETIME = '2018-04-01';
DECLARE @END_DATE   DATETIME = '2019-03-31';

SELECT 
    X.*,
    -- Calculations for Weeks
    DATEDIFF(WK, X.CLOCK_START_DATE, ISNULL(X.FIRST_FTF_DATE, @END_DATE))  AS REF_TO_FIRST_APT_WEEKS,
    DATEDIFF(WK, X.CLOCK_START_DATE, ISNULL(X.SECOND_FTF_DATE, @END_DATE)) AS REF_TO_SECOND_APT_WEEKS,

    -- Benchmarking Groups
    CASE 
        WHEN DATEDIFF(WK, X.CLOCK_START_DATE, ISNULL(X.SECOND_FTF_DATE, @END_DATE)) < 6           THEN '<6'
        WHEN DATEDIFF(WK, X.CLOCK_START_DATE, ISNULL(X.SECOND_FTF_DATE, @END_DATE)) BETWEEN 6 AND 18 THEN '6_TO_18'
        WHEN DATEDIFF(WK, X.CLOCK_START_DATE, ISNULL(X.SECOND_FTF_DATE, @END_DATE)) > 18          THEN '>18'
    END AS REF_TO_SECOND_APT_WEEKS_GROUP,

    -- Calculations for Days and Hours
    DATEDIFF(DD, X.CLOCK_START_DATE, ISNULL(X.FIRST_FTF_DATE, @END_DATE))  AS REF_TO_FIRST_APT_DAYS,
    DATEDIFF(DD, X.CLOCK_START_DATE, ISNULL(X.SECOND_FTF_DATE, @END_DATE)) AS REF_TO_SECOND_APT_DAYS,
    DATEDIFF(HH, X.CLOCK_START_DATE, ISNULL(X.FIRST_FTF_DATE, @END_DATE))  AS REF_TO_FIRST_APT_HRS,
    DATEDIFF(HH, X.CLOCK_START_DATE, ISNULL(X.SECOND_FTF_DATE, @END_DATE)) AS REF_TO_SECOND_APT_HRS

FROM (
    SELECT DISTINCT
        REFT.PATIENT_KEY,
        CL.CLIENTID,
        REFT.REFERRAL_UNIQUE_ID,
        REFT.SERVICE_KEY,
        ORG.BENCHMARKING_DESC,
        ORG.SERVICE_SSCODE AS TEAM_CODE,
        ORG.SERVICE_SSDESC AS TEAMS_DESC,
        ORG.BOROUGH_DESC   AS BOROUGH,
        ORG.CSU_DESC       AS CSU,
        ORG.SERVICE_LINE_DESC,
        ORG.SUB_SERVICE_LINE_DESC,

        -- Team Dates
        CONVERT(DATETIME, CONVERT(CHAR(8), REFT.ALLOCATION_START_DATE_KEY)) + ' ' + CONVERT(CHAR(8), REFT.ALLOCATION_START_TIME, 108) AS TEAM_REF_DATE,
        CONVERT(DATETIME, CONVERT(CHAR(8), REFT.ALLOCATION_END_DATE_KEY))   + ' ' + CONVERT(CHAR(8), REFT.ALLOCATION_END_TIME, 108)   AS TEAM_DISCH_DATE,

        -- Overall Referral Dates
        CONVERT(DATETIME, CONVERT(CHAR(8), REF.REFERRAL_DATE_KEY)) + ' ' + CONVERT(CHAR(8), REF.REFERRAL_TIME, 108)  AS OVERALL_REF_DATE,
        CONVERT(DATETIME, CONVERT(CHAR(8), REF.DISCHARGE_DATE_KEY)) + ' ' + CONVERT(CHAR(8), REF.DISCHARGE_TIME, 108) AS OVERALL_DISCH_DATE,

        REF.REFERRAL_SOURCE_DESC,
        REF.PRIORITY_DESC,
        FTF1.FIRST_FTF_DATE,
        FTF2.SECOND_FTF_DATE,
        DNA1.FIRST_DNA_DATE,

        -- Clock Start Logic: If DNA exists before FTF, use DNA date, else use Referral Date
        ISNULL(DNA1.FIRST_DNA_DATE, CONVERT(DATETIME, CONVERT(CHAR(8), REF.REFERRAL_DATE_KEY)) + ' ' + CONVERT(CHAR(8), REF.REFERRAL_TIME, 108)) AS CLOCK_START_DATE,

        -- Status Flags
        CASE WHEN FTF1.FIRST_FTF_DATE IS NULL THEN 'Y' ELSE 'N' END AS WAITING_FOR_FIRST_FTF,
        CASE WHEN FTF2.SECOND_FTF_DATE IS NULL THEN 'Y' ELSE 'N' END AS WAITING_FOR_SECOND_FTF,
        
        CASE 
            WHEN CONVERT(DATETIME, CONVERT(CHAR(8), REFT.ALLOCATION_START_DATE_KEY)) <= @END_DATE
                 AND (CONVERT(DATETIME, CONVERT(CHAR(8), REFT.ALLOCATION_END_DATE_KEY)) > @END_DATE OR REFT.ALLOCATION_END_DATE_KEY IS NULL) 
            THEN 'Y' ELSE 'N' 
        END AS ACTIVE_AT_YR_END,

        CASE WHEN FTF1.FIRST_FTF_DATE BETWEEN @START_DATE AND @END_DATE THEN 'Y' ELSE 'N' END AS FIRST_FTF_IN_YR,
        CASE WHEN FTF2.SECOND_FTF_DATE BETWEEN @START_DATE AND @END_DATE THEN 'Y' ELSE 'N' END AS SECOND_FTF_IN_YR,
        CASE WHEN FTF3.PATIENT_KEY IS NOT NULL THEN 'Y' ELSE 'N' END AS ANY_FTF_IN_YR

    FROM FACT_REFERRAL_SERVICE REFT
    LEFT JOIN FACT_REFERRAL REF 
        ON REFT.PATIENT_KEY = REF.PATIENT_KEY 
        AND REFT.REFERRAL_UNIQUE_ID = REF.REFERRAL_UNIQUE_ID
    LEFT JOIN DIM_SERVICE ORG 
        ON ORG.SERVICE_KEY = REFT.SERVICE_KEY 
        AND ORG.RECORD_STATUS = 'A'
    LEFT JOIN DIM_PATIENT CL 
        ON CL.PATIENT_KEY = REFT.PATIENT_KEY 
        AND CL.RECORD_STATUS = 'A'

    -- FIRST FTF APPOINTMENT
    LEFT JOIN (
        SELECT 
            PATIENT_KEY, 
            REFERRAL_UNIQUE_ID,
            CONVERT(DATETIME, CONVERT(CHAR(8), APPOINTMENT_DATE_KEY, 112) + ' ' + CONVERT(CHAR(8), APPOINTMENT_TIME, 108)) AS FIRST_FTF_DATE
        FROM FACT_APPOINTMENT
        WHERE APPOINTMENT_ATTENDED_FTF_ORDER_NO = 1
          AND HCP_TYPE = 'LEAD'
    ) FTF1 ON REFT.PATIENT_KEY = FTF1.PATIENT_KEY AND FTF1.REFERRAL_UNIQUE_ID = REFT.REFERRAL_UNIQUE_ID

    -- SECOND FTF APPOINTMENT
    LEFT JOIN (
        SELECT 
            PATIENT_KEY, 
            REFERRAL_UNIQUE_ID,
            CONVERT(DATETIME, CONVERT(CHAR(8), APPOINTMENT_DATE_KEY, 112) + ' ' + CONVERT(CHAR(8), APPOINTMENT_TIME, 108)) AS SECOND_FTF_DATE
        FROM FACT_APPOINTMENT
        WHERE APPOINTMENT_ATTENDED_FTF_ORDER_NO = 2
          AND HCP_TYPE = 'LEAD'
    ) FTF2 ON REFT.PATIENT_KEY = FTF2.PATIENT_KEY AND FTF2.REFERRAL_UNIQUE_ID = REFT.REFERRAL_UNIQUE_ID

    -- FIRST DNA (BEFORE FIRST FTF)
    LEFT JOIN (
        SELECT 
            PATIENT_KEY, 
            REFERRAL_UNIQUE_ID,
            CONVERT(DATETIME, CONVERT(CHAR(8), APPOINTMENT_DATE_KEY, 112) + ' ' + CONVERT(CHAR(8), APPOINTMENT_TIME, 108)) AS FIRST_DNA_DATE
        FROM FACT_APPOINTMENT
        WHERE HCP_TYPE = 'LEAD'
          AND APPOINTMENT_DNA_ORDER_NO = 1
    ) DNA1 ON REFT.PATIENT_KEY = DNA1.PATIENT_KEY AND DNA1.REFERRAL_UNIQUE_ID = REFT.REFERRAL_UNIQUE_ID 
          AND DNA1.FIRST_DNA_DATE < ISNULL(FTF1.FIRST_FTF_DATE, GETDATE()) 
          AND DNA1.FIRST_DNA_DATE < ISNULL(CONVERT(DATETIME, CONVERT(CHAR(8), REFT.ALLOCATION_END_DATE_KEY)), GETDATE())
          AND DNA1.FIRST_DNA_DATE > CONVERT(DATETIME, CONVERT(CHAR(8), REFT.ALLOCATION_START_DATE_KEY))
          AND DNA1.FIRST_DNA_DATE < @END_DATE

    -- ANY FTF IN REPORTING YEAR
    LEFT JOIN (
        SELECT DISTINCT PATIENT_KEY, REFERRAL_UNIQUE_ID
        FROM FACT_APPOINTMENT
        WHERE APPOINTMENT_ATTENDED_FTF_ORDER_NO IS NOT NULL
          AND CONVERT(DATETIME, CONVERT(CHAR(8), APPOINTMENT_DATE_KEY, 112)) BETWEEN @START_DATE AND @END_DATE
          AND HCP_TYPE = 'LEAD'
    ) FTF3 ON REFT.PATIENT_KEY = FTF3.PATIENT_KEY AND FTF3.REFERRAL_UNIQUE_ID = REFT.REFERRAL_UNIQUE_ID

    WHERE 1=1
      AND CONVERT(DATETIME, CONVERT(CHAR(8), REFT.ALLOCATION_START_DATE_KEY)) <= @END_DATE
      AND ORG.CSU_DESC NOT IN ('TEST', 'DEFAULT')
      AND ORG.SUB_SERVICE_LINE_DESC LIKE '%CAMHS%'
      AND CL.LOGIC_DELETE = 'NO'
      AND CL.TEST_PATIENT_FLAG = '0'
      AND CL.DELETED_FLAG = '0'
) X;
