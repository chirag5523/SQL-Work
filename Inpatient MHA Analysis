/*
TITLE: Inpatient MHA Analysis
DESCRIPTION: 
    Analyzes inpatient episodes in relation to Mental Health Act (MHA) sections.
    Includes:
    - Age grouping at admission.
    - Legal status at the exact time of admission.
    - The latest MHA section relative to discharge.
    - The first MHA section applied after the admission date.
*/

SELECT 
    A.PATIENT_KEY,
    B.CLIENTID,
    B.GENDER_DESC,
    B.ETHNICITY_DESC,
    DATEDIFF(DD, B.DATE_OF_BIRTH, D.FULL_DATE) / 365.25 AS AGE_ON_ADMISSION,

    -- Age Grouping Logic
    CASE 
        WHEN DATEDIFF(DD, B.DATE_OF_BIRTH, D.FULL_DATE) / 365.25 < 16 THEN '15_OR_LESS'
        WHEN DATEDIFF(DD, B.DATE_OF_BIRTH, D.FULL_DATE) / 365.25 BETWEEN 16 AND 17.99 THEN '16_TO_17'
        WHEN DATEDIFF(DD, B.DATE_OF_BIRTH, D.FULL_DATE) / 365.25 BETWEEN 18 AND 34.99 THEN '18_TO_34'
        WHEN DATEDIFF(DD, B.DATE_OF_BIRTH, D.FULL_DATE) / 365.25 BETWEEN 35 AND 49.99 THEN '35_TO_49'
        WHEN DATEDIFF(DD, B.DATE_OF_BIRTH, D.FULL_DATE) / 365.25 BETWEEN 50 AND 64.99 THEN '50_TO_64'
        WHEN DATEDIFF(DD, B.DATE_OF_BIRTH, D.FULL_DATE) / 365.25 >= 65 THEN '65_AND_OVER'
    END AS AGE_ON_ADMISSION_GROUP,

    A.SERVICE_KEY,
    A.EVENT_NUMBER,
    A.INPATIENT_UNIQUE_ID,
    C.SERVICE_SSDESC,
    C.SUB_SERVICE_LINE_DESC,
    C.SERVICE_LINE_DESC,
    C.BOROUGH_DESC,
    A.LEGAL_STATUS_CODE AS ADMISSION_LEGAL_STATUS_CODE,
    A.LEGAL_STATUS_DESC AS ADMISSION_LEGAL_STATUS_DESC,
    
    CASE 
        WHEN A.LEGAL_STATUS_CODE IN ('01', 'NR', 'UNK') THEN 'Informal' 
        ELSE 'Formal' 
    END AS ADMISSION_LEGAL_STATUS_GROUP,

    X2.SECTION_CODE AS SECTION_MHA_CODE,
    X2.SECTION_DESC AS SECTION_MHA_DESC,
    X2.SEC_MHA_START_DATE_TIME,
    X2.SEC_MHA_END_DATE_TIME,

    CASE 
        WHEN (X2.SECTION_CODE IN ('01', 'NR', 'UNK') OR X2.SECTION_CODE IS NULL) THEN 'Informal' 
        ELSE 'Formal' 
    END AS SECTION_MHA_CHECK,

    -- Admission and Discharge Timestamps
    CAST(D.FULL_DATE AS DATETIME) + CAST(A.ADMISSION_TIME AS DATETIME) AS ADMISSION_DATE_TIME,
    D.FIRST_DAY_OF_MONTH AS ADMISSION_MONTH,
    D.FISCAL_YEAR AS ADMISSION_FISCAL_YEAR,
    D.WEEK_BEGIN_DATE AS ADMISSION__WEEK,

    CAST(D1.FULL_DATE AS DATETIME) + CAST(A.DISCHARGE_TIME AS DATETIME) AS DISCHARGE_DATE_TIME,
    D1.FIRST_DAY_OF_MONTH AS DISCHARGE_MONTH,
    D1.FISCAL_YEAR AS DISCHARGE_FISCAL_YEAR,
    D1.WEEK_BEGIN_DATE AS DISCHARGE__WEEK,

    CASE WHEN A.DISCHARGE_DATE_KEY IS NULL THEN 'Y' ELSE 'N' END AS OPEN_INPATIENT_SPELL,
    A.REFERRAL_TYPE_CODE,

    -- Latest MHA Section Details
    X.MHA_SECTION_ID,
    X.EVENT_NUMBER AS MHA_SECTION_EVENT_NO,
    X.RENEWAL_NUMBER,
    X.SECTION_CODE AS CURRENT_SECTION_CODE,
    X.SEC_START_DATE AS CURRENT_SECTION_START_DATE,
    X.SEC_START_TIME AS CURRENT_SECTION_START_TIME,
    X.SEC_END_DATE AS CURRENT_SECTION_END_DATE,
    X.SEC_END_TIME AS CURRENT_SECTION_END_TIME,
    X.SEC_STATUS,
    X.CLIENT_CAT_CODE,
    X.CLIENT_CAT_DESC,
    X.ADMISSION_LEGAL_STATUS_SSCODE AS [EARLIEST_MH_SEC_LEGAL_CODE],  
    X.ADMISSION_LEGAL_STATUS_SSDESC AS [EARLIEST_MH_SEC_LEGAL_DESC],
    X.CTO_STATUS_SSCODE,
    X.CTO_STATUS_SSDESC,
    X.CTO_CONDITION,
    X.SOCIAL_SERVICE_NOTIFIED_DATE,
    X.END_SEC_REASON_SSCODE,
    X.END_SEC_REASON_SSDESC,
    X.END_SEC_REASON_CODE,
    X.END_SEC_REASON_DESC,
    X.LEAD_STAFF_KEY,
    X.FIRST_MEDICAL_RECOMMENDATION_STAFF,
    X.SECOND_MEDICAL_RECOMMENDATION_STAFF,
    X.SUP_STAFF_KEY,
    X.LEAF_LET_SSCODE,
    X.LEAF_LET_SSDESC,

    -- Standardized Date Keys
    CONVERT(DATE, CAST(X.LEAF_LET_GIVEN_DATE_KEY AS VARCHAR(10))) AS LEAF_LET_GIVEN_DATE,
    CONVERT(DATE, CAST(X.NEXT_EXPIRY_DATE_KEY AS VARCHAR(10))) AS NEXT_EXPIRY_DATE,
    X.NEXT_EXPIRY_TIME,
    CONVERT(DATE, CAST(X.NEXT_REVIEW_DATE_KEY AS VARCHAR(10))) AS NEXT_REVIEW_DATE,
    X.NEXT_REVIEW_TIME,
    CONVERT(DATE, CAST(X.SEC_117_DATE_KEY AS VARCHAR(10))) AS SEC_117_DATE,
    CONVERT(DATE, CAST(X.CTO_STATUS_DATE_KEY AS VARCHAR(10))) AS CTO_STATUS_DATE,
    CONVERT(DATE, CAST(X.RESTRICTION_END_DATE_KEY AS VARCHAR(10))) AS RESTRICTION_END_DATE,
    CONVERT(DATE, CAST(X.NOK_NOTIFIED_DATE_KEY AS VARCHAR(10))) AS NOK_NOTIFIED_DATE,
    CONVERT(DATE, CAST(X.DATE_RIGHTS_GIVEN_TO_PATIENT_KEY AS VARCHAR(10))) AS DATE_RIGHTS_GIVEN_TO_PATIENT_KEY,

    X1.SECTION_SSCODE AS FIRST_SECTION_AFTER_ADMISSION_CODE,
    X1.SECTION_SSDESC AS FIRST_SECTION_AFTER_ADMISSION_DESC

FROM FACT_INPATIENT_EPISODE A
LEFT JOIN DIM_PATIENT B 
    ON A.PATIENT_KEY = B.PATIENT_KEY 
    AND B.RECORD_STATUS = 'A'
LEFT JOIN DIM_SERVICE C 
    ON A.SERVICE_KEY = C.SERVICE_KEY 
    AND C.RECORD_STATUS = 'A'
LEFT JOIN DIM_DATE D 
    ON A.ADMISSION_DATE_KEY = D.DATE_KEY
LEFT JOIN DIM_DATE D1 
    ON A.DISCHARGE_DATE_KEY = D1.DATE_KEY

-- LATEST MH SECTION OPEN (Relative to discharge/current date)
OUTER APPLY (
    SELECT TOP (1) 
        MH.*, 
        MD.FULL_DATE AS SEC_START_DATE, 
        MD1.FULL_DATE AS SEC_END_DATE
    FROM FACT_MHA MH
    LEFT JOIN DIM_DATE MD ON MH.SEC_START_DATE_KEY = MD.DATE_KEY
    LEFT JOIN DIM_DATE MD1 ON MH.SEC_END_DATE_KEY = MD1.DATE_KEY
    WHERE A.PATIENT_KEY = MH.PATIENT_KEY 
      AND MD.FULL_DATE < ISNULL(D1.FULL_DATE, GETDATE())
    ORDER BY MD.FULL_DATE DESC
) X

-- EARLIEST MH SECTION AFTER ADMISSION
OUTER APPLY (
    SELECT TOP (1) 
        MH.*, 
        MD.FULL_DATE AS SEC_START_DATE, 
        MD1.FULL_DATE AS SEC_END_DATE
    FROM FACT_MHA MH
    LEFT JOIN DIM_DATE MD ON MH.SEC_START_DATE_KEY = MD.DATE_KEY
    LEFT JOIN DIM_DATE MD1 ON MH.SEC_END_DATE_KEY = MD1.DATE_KEY
    WHERE A.PATIENT_KEY = MH.PATIENT_KEY
      AND MD.FULL_DATE > D.FULL_DATE
    ORDER BY MD.FULL_DATE ASC
) X1

-- FORMAL / INFORMAL SECTION AT EXACT ADMISSION TIME
OUTER APPLY (
    SELECT TOP (1) 
        MH.[MHA_SECTION_ID], 
        MH.[PATIENT_KEY], 
        MH.[SECTION_CODE], 
        MH.[SECTION_DESC],
        CAST(DT.FULL_DATE AS DATETIME) + CAST(MH.SEC_START_TIME AS DATETIME) AS SEC_MHA_START_DATE_TIME,
        CAST(DT1.FULL_DATE AS DATETIME) + CAST(MH.SEC_END_TIME AS DATETIME) AS SEC_MHA_END_DATE_TIME
    FROM FACT_MHA MH
    LEFT JOIN DIM_DATE DT  ON MH.SEC_START_DATE_KEY = DT.DATE_KEY
    LEFT JOIN DIM_DATE DT1 ON MH.SEC_END_DATE_KEY   = DT1.DATE_KEY
    WHERE A.PATIENT_KEY = MH.PATIENT_KEY
      AND (
          (CAST(DT.FULL_DATE AS DATETIME) + CAST(MH.SEC_START_TIME AS DATETIME)) <= (CAST(D.FULL_DATE AS DATETIME) + CAST(A.ADMISSION_TIME AS DATETIME))
          AND
          (CAST(DT1.FULL_DATE AS DATETIME) + CAST(MH.SEC_END_TIME AS DATETIME)) >= (CAST(D.FULL_DATE AS DATETIME) + CAST(A.ADMISSION_TIME AS DATETIME))
      ) 
    ORDER BY MH.SEC_START_DATE_KEY DESC
) X2

WHERE (
    D.FULL_DATE >= '2019-04-01' 
    OR D1.FULL_DATE >= '2019-04-01' 
    OR A.DISCHARGE_DATE_KEY IS NULL
)
  AND C.SERVICE_LINE_DESC NOT IN ('Test', 'Default')
  AND B.DELETED_FLAG = 0
  AND B.TEST_PATIENT_FLAG = 0
  AND B.PATIENT_FLAG = 1
  AND B.LOGIC_DELETE = 'No'

ORDER BY A.PATIENT_KEY, A.ADMISSION_DATE_KEY DESC;
